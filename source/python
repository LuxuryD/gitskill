import cv2
import numpy as np
from PIL import Image
import pytesseract
import os

# 配置 Tesseract 路径（Windows 需修改为你的安装路径）
pytesseract.pytesseract.tesseract_cmd = r'C:\Program Files\Tesseract-OCR\tesseract.exe'

def split_gif_frames(gif_path, output_dir="gif_frames"):
    """拆分 GIF 为单帧图像并保存"""
    os.makedirs(output_dir, exist_ok=True)
    img = Image.open(gif_path)
    frames = []
    try:
        while True:
            # 保存当前帧
            frame_path = f"{output_dir}/frame_{len(frames)}.png"
            img.save(frame_path)
            frames.append(frame_path)
            img.seek(img.tell() + 1)  # 跳转到下一帧
    except EOFError:
        pass  # 帧读取完毕
    return frames

def preprocess_image(image_path):
    """图像预处理：灰度化→降噪→二值化"""
    img = cv2.imread(image_path)
    # 1. 转为灰度图
    gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
    # 2. 高斯模糊降噪
    blurred = cv2.GaussianBlur(gray, (3, 3), 0)
    # 3. 自适应阈值二值化（处理光照不均）
    thresh = cv2.adaptiveThreshold(
        blurred, 255,
        cv2.ADAPTIVE_THRESH_GAUSSIAN_C,
        cv2.THRESH_BINARY_INV,
        blockSize=11,
        C=2
    )
    # 4. 形态学操作去除小干扰点
    kernel = np.ones((2, 2), np.uint8)
    processed = cv2.morphologyEx(thresh, cv2.MORPH_CLOSE, kernel)
    return processed

def ocr_captcha(image):
    """调用 Tesseract 识别字符，配置验证码参数"""
    # config 参数：仅识别数字字母，关闭字典匹配，提高验证码识别率
    config = r'--oem 3 --psm 8 -c tessedit_char_whitelist=0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'
    text = pytesseract.image_to_string(image, config=config)
    return text.strip()

def recognize_gif_captcha(gif_path):
    """识别 GIF 验证码主函数"""
    # 1. 拆分 GIF 帧
    frames = split_gif_frames(gif_path)
    if not frames:
        return "未提取到 GIF 帧"
    
    # 2. 遍历每一帧，预处理 + OCR 识别
    results = []
    for frame_path in frames:
        processed_img = preprocess_image(frame_path)
        text = ocr_captcha(processed_img)
        if text:  # 过滤空结果
            results.append(text)
    
    # 3. 去重并返回最可能的结果（验证码通常单帧有效，多帧结果一致则可信度高）
    if results:
        most_common = max(set(results), key=results.count)
        return f"识别结果：{most_common}（候选结果：{results}）"
    else:
        return "未识别到有效字符"

# 测试示例
if __name__ == "__main__":
    gif_path = "your_captcha.gif"  # 替换为你的 GIF 验证码路径
    print(recognize_gif_captcha(gif_path))